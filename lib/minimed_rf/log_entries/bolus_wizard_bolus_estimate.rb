# xxxxxxxx xxxxxxxx MMxxxxxx MMxxxxxx ?S?xxxxx ???xxxxx xxxxxxxx xxxxxxxx ????CHBG ?????xxxxxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxxxxxxxxxx xxxxx??? xxxxxxxxxxxxxxxx xxxxxxxxxxxxxxxx xxxxxxxx
# command  BG       seconds  minutes  hours    day      year     CH       highbits carb ratio       senstvty bg low   corr     food estimate    HBcorr   unabsorbed ins.  bolus estimate   bg high
# 0        1        2        3        4        5        6        7        8        9      10        11       12       13       14      15       16       17      18       19     20        21
# 889,1/5/14,01:11:19,1/5/14 01:11:19,,,,,,,,,,,,,,,1.0,180,80,15,50,15,80,0,1,2.4,,,,,,BolusWizardBolusEstimate,"BG_INPUT=80, BG_UNITS=mg dl, CARB_INPUT=15, CARB_UNITS=grams, CARB_RATIO=15, INSULIN_SENSITIVITY=50, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=1, CORRECTION_ESTIMATE=0, FOOD_ESTIMATE=1, UNABSORBED_INSULIN_TOTAL=2.4, UNABSORBED_INSULIN_COUNT=3, ACTION_REQUESTOR=paradigm link or b key",12073514759,52854685,82,MiniMed 530G - 551
# 01011011 01010000 00010011 01001011 00000001 01100101 00001110 00001111 01010000 0000000010010110 00110010 01010000 00000000 0000000000101000 00000000 0000000001100000 0000000000101000 10110100
# 5b       50       13       4b       01       65       0e       0f       50       0096             32       50       00       0028             00       0060             0028             b4
# 895,1/5/14,01:12:36,1/5/14 01:12:36,,,,,,,,,,,,,,,1.0,180,80,15,50,16,80,0,1,3.3,,,,,,BolusWizardBolusEstimate,"BG_INPUT=80, BG_UNITS=mg dl, CARB_INPUT=16, CARB_UNITS=grams, CARB_RATIO=15, INSULIN_SENSITIVITY=50, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=1, CORRECTION_ESTIMATE=0, FOOD_ESTIMATE=1, UNABSORBED_INSULIN_TOTAL=3.3, UNABSORBED_INSULIN_COUNT=4, ACTION_REQUESTOR=paradigm link or b key",12073514753,52854685,76,MiniMed 530G - 551
# 01011011 01010000 00100100 01001100 00000001 01100101 00001110 00010000 01010000 0000000010010110 00110010 01010000 00000000 0000000000101000 00000000 0000000010000100 0000000000101000 10110100
# 5b       50       24       4c       01       65       0e       10       50       0096             32       50       00       0028             00       0084             0028             b4
# 973,1/5/14,14:21:45,1/5/14 14:21:45,,,,,,,,,,,,,,,1.3,180,80,15,50,20,100,0,1.3,0.0,,,,,,BolusWizardBolusEstimate,"BG_INPUT=100, BG_UNITS=mg dl, CARB_INPUT=20, CARB_UNITS=grams, CARB_RATIO=15, INSULIN_SENSITIVITY=50, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=1.3, CORRECTION_ESTIMATE=0, FOOD_ESTIMATE=1.3, UNABSORBED_INSULIN_TOTAL=0, UNABSORBED_INSULIN_COUNT=0, ACTION_REQUESTOR=paradigm link or b key",12077548015,52856063,82,MiniMed 530G - 551
# 01011011 01010000 00100100 01001100 00000001 01100101 00001110 00010000 01010000 0000000010010110 00110010 01010000 00000000 0000000000101000 00000000 0000000010000100 0000000000101000 10110100
# 5b       64       2d       55       0e       65       0e       14       50       0096             32       50       00       0034             00       0000             0034             b4
# 976,1/5/14,14:24:05,1/5/14 14:24:05,,,,,,,,,,,,,,,1.3,180,80,15,50,20,100,0,1.3,1.3,,,,,,BolusWizardBolusEstimate,"BG_INPUT=100, BG_UNITS=mg dl, CARB_INPUT=20, CARB_UNITS=grams, CARB_RATIO=15, INSULIN_SENSITIVITY=50, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=1.3, CORRECTION_ESTIMATE=0, FOOD_ESTIMATE=1.3, UNABSORBED_INSULIN_TOTAL=1.3, UNABSORBED_INSULIN_COUNT=1, ACTION_REQUESTOR=paradigm link or b key",12077548012,52856063,79,MiniMed 530G - 551
# 01011011 01100100 00000101 01011000 00001110 01100101 00001110 00010100 01010000 0000000010010110 00110010 01010000 00000000 0000000000110100 00000000 0000000000110100 0000000000110100 10110100
# 5b       64       05       58       0e       65       0e       14       50       0096             32       50       00       0034             00       0034             0034             b4
# 978,1/5/14,14:26:47,1/5/14 14:26:47,,,,,,,,,,,,,,,1.4,180,80,15,50,21,100,0,1.4,2.6,,,,,,BolusWizardBolusEstimate,"BG_INPUT=100, BG_UNITS=mg dl, CARB_INPUT=21, CARB_UNITS=grams, CARB_RATIO=15, INSULIN_SENSITIVITY=50, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=1.4, CORRECTION_ESTIMATE=0, FOOD_ESTIMATE=1.4, UNABSORBED_INSULIN_TOTAL=2.6, UNABSORBED_INSULIN_COUNT=1, ACTION_REQUESTOR=paradigm link or b key",12077548009,52856063,76,MiniMed 530G - 551
# 01011011 01100100 00101111 01011010 00001110 01100101 00001110 00010101 01010000 0000000010010110 00110010 01010000 00000000 0000000000111000 00000000 0000000001101000 0000000000111000 10110100
# 5b       64       2f       5a       0e       65       0e       15       50       0096             32       50       00       0038             00       0068             0038             b4
# 1057,1/5/14,15:07:23,1/5/14 15:07:23,,,,,,,,,,,,,,,25.2,180,80,15,50,300,600,8.4,20,3.2,,,,,,BolusWizardBolusEstimate,"BG_INPUT=600, BG_UNITS=mg dl, CARB_INPUT=300, CARB_UNITS=grams, CARB_RATIO=15, INSULIN_SENSITIVITY=50, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=25.2, CORRECTION_ESTIMATE=8.4, FOOD_ESTIMATE=20, UNABSORBED_INSULIN_TOTAL=3.2, UNABSORBED_INSULIN_COUNT=2, ACTION_REQUESTOR=paradigm link or b key",12077969156,52856228,76,MiniMed 530G - 551
# 01011011 01011000 00010111 01000111 00001111 01100101 00001110 00101100 01010110 0000000010010110 00110010 01010000 01010000 0000001100100000 00001000 0000000010000000 0000001111110000 10110100
# 5b       58       17       47       0f       65       0e       2c       56       0096             32       50       50       0320             08       0080             03f0             b4
# 1140,1/5/14,19:17:57,1/5/14 19:17:57,,,,,,,,,,,,,,,20.0,180,80,15,50,300,100,0,20,0.0,,,,,,BolusWizardBolusEstimate,"BG_INPUT=100, BG_UNITS=mg dl, CARB_INPUT=300, CARB_UNITS=grams, CARB_RATIO=15, INSULIN_SENSITIVITY=50, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=20, CORRECTION_ESTIMATE=0, FOOD_ESTIMATE=20, UNABSORBED_INSULIN_TOTAL=0, UNABSORBED_INSULIN_COUNT=3, ACTION_REQUESTOR=paradigm link or b key",12079809505,52856852,107,MiniMed 530G - 551
# 01011011 01100100 00111001 01010001 00010011 01100101 00001110 00101100 01010100 0000000010010110 00110010 01010000 00000000 0000001100100000 00000000 0000000000000000 0000001100100000 10110100
# 5b       64       39       51       13       65       0e       2c       54       0096             32       50       00       0320             00       0000             0320             b4
# 1147,1/5/14,19:27:09,1/5/14 19:27:09,,,,,,,,,,,,,,,1.4,180,80,15,50,21,600,8.4,1.4,19.8,,,,,,BolusWizardBolusEstimate,"BG_INPUT=600, BG_UNITS=mg dl, CARB_INPUT=21, CARB_UNITS=grams, CARB_RATIO=15, INSULIN_SENSITIVITY=50, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=1.4, CORRECTION_ESTIMATE=8.4, FOOD_ESTIMATE=1.4, UNABSORBED_INSULIN_TOTAL=19.8, UNABSORBED_INSULIN_COUNT=4, ACTION_REQUESTOR=paradigm link or b key",12079809498,52856852,100,MiniMed 530G - 551
# 01011011 01011000 00001001 01011011 00010011 01100101 00001110 00010101 01010010 0000000010010110 00110010 01010000 01010000 0000000000111000 00001000 0000001100011000 0000000000111000 10110100
# 5b       58       09       5b       13       65       0e       15       52       0096             32       50       50       0038             08       0318             0038             b4
# 1172,1/5/14,19:34:14,1/5/14 19:34:14,,,,,,,,,,,,,,,1.0,180,80,20,50,20,100,0,1,20.7,,,,,,BolusWizardBolusEstimate,"BG_INPUT=100, BG_UNITS=mg dl, CARB_INPUT=20, CARB_UNITS=grams, CARB_RATIO=20, INSULIN_SENSITIVITY=50, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=1, CORRECTION_ESTIMATE=0, FOOD_ESTIMATE=1, UNABSORBED_INSULIN_TOTAL=20.7, UNABSORBED_INSULIN_COUNT=5, ACTION_REQUESTOR=paradigm link or b key",12079809474,52856852,76,MiniMed 530G - 551
# 01011011 01100100 00001110 01100010 00010011 01100101 00001110 00010100 01010000 0000000011001000 00110010 01010000 00000000 0000000000101000 00000000 0000001100111100 0000000000101000 10110100
# 5b       64       0e       62       13       65       0e       14       50       00c8             32       50       00       0028             00       033c             0028             b4

# xxxxxxxx xxxxxxxx MMxxxxxx MMxxxxxx ?S?xxxxx ???xxxxx xxxxxxxx xxxxxxxx ????CHBG ?????xxxxxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxx xxxxxxxxxxxxxxxx xxxxx??? xxxxxxxxxxxxxxxx xxxxxxxxxxxxxxxx xxxxxxxx
# command  BG       seconds  minutes  hours    day      year     CH       highbits carb ratio       senstvty bg low   corr     food estimate    HBcorr   unabsorbed ins.  bolus estimate   bg high

# 1419,1/5/14,23:07:48,1/5/14 23:07:48,,,,,,,,,,,,,,,42.0,180,80,20,10,0,600,42,0,0.0,,,,,,BolusWizardBolusEstimate,"BG_INPUT=600, BG_UNITS=mg dl, CARB_INPUT=0, CARB_UNITS=grams, CARB_RATIO=20, INSULIN_SENSITIVITY=10, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=42, CORRECTION_ESTIMATE=42, FOOD_ESTIMATE=0, UNABSORBED_INSULIN_TOTAL=0, UNABSORBED_INSULIN_COUNT=2, ACTION_REQUESTOR=paradigm link or b key",12081136002,52857289,100,MiniMed 530G - 551
# 01011011 01011000 00110000 01000111 00010111 01100101 00001110 00000000 01010010 0000000011001000 00001010 01010000 10010000 0000000000000000 00110000 0000000000000000 0000011010010000 10110100
# 5b       58       30       47       17       65       0e       00       52       00c8             0a       50       90       0000             30       0000             0690             b4
# 1438,1/5/14,23:19:19,1/5/14 23:19:19,,,,,,,,,,,,,,,0.0,180,80,20,400,0,600,1,0,24.6,,,,,,BolusWizardBolusEstimate,"BG_INPUT=600, BG_UNITS=mg dl, CARB_INPUT=0, CARB_UNITS=grams, CARB_RATIO=20, INSULIN_SENSITIVITY=400, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=0, CORRECTION_ESTIMATE=1, FOOD_ESTIMATE=0, UNABSORBED_INSULIN_TOTAL=24.6, UNABSORBED_INSULIN_COUNT=3, ACTION_REQUESTOR=paradigm link or b key",12081127982,52857289,80,MiniMed 530G - 551
# 01011011 01011000 00010011 01010011 01010111 01100101 00001110 00000000 01010010 0000000011001000 10010000 01010000 00101000 0000000000000000 00000000 0000001111011000 0000000000000000 10110100
# 5b       58       13       53       57       65       0e       00       52       00c8             90       50       28       0000             00       03d8             0000             b4
# 1442,1/5/14,23:19:35,1/5/14 23:19:35,,,,,,,,,,,,,,,0.0,180,80,20,400,0,600,1,0,24.6,,,,,,BolusWizardBolusEstimate,"BG_INPUT=600, BG_UNITS=mg dl, CARB_INPUT=0, CARB_UNITS=grams, CARB_RATIO=20, INSULIN_SENSITIVITY=400, BG_TARGET_LOW=80, BG_TARGET_HIGH=180, BOLUS_ESTIMATE=0, CORRECTION_ESTIMATE=1, FOOD_ESTIMATE=0, UNABSORBED_INSULIN_TOTAL=24.6, UNABSORBED_INSULIN_COUNT=3, ACTION_REQUESTOR=paradigm link or b key",12081127978,52857289,76,MiniMed 530G - 551
# 01011011 01011000 00100011 01010011 01010111 01100101 00001110 00000000 01010010 0000000011001000 10010000 01010000 00101000 0000000000000000 00000000 0000001111011000 0000000000000000 10110100
# 5b       58       23       53       57       65       0e       00       52       00c8             90       50       28       0000             00       03d8             0000             b4

module MinimedRF
  module PumpEvents
    class BolusWizardBolusEstimate < Base

      def self.event_type_code
        0x5b
      end

      def length
        22
      end

      def to_s
        # "#{bolus_type} #{timestamp_str} CH:#{carbohydrates} BG:#{blood_glucose} Carb Ratio:#{carb_ratio} Insulin Sensitivity:#{insulin_sensitivity} Bolus Estimate:#{bolus_estimate} Food Estimate:#{food_estimate} Correction Estimate:#{correction_estimate} Unabsorbed Insulin Total:#{unabsorbed_insulin_total}"
        "#{bolus_type} #{timestamp_str} "
      end

      def insulin_decode(a, b)
        ((a << 8) + b) / 40.0
      end

      def carbohydrates
        ((d(8) & 0xc) << 6) + d(7)
      end

      def blood_glucose
        ((d(8) & 0x3) << 8) + d(1)
      end

      def bolus_type
        "BolusWizardBolusEstimate"
      end

      def food_estimate
        insulin_decode(d(14), d(15))
      end

      def correction_estimate
        (((d(16) & 0x38) << 5) + d(13)) / 40.0
      end

      def bolus_estimate
        insulin_decode(d(19), d(20))
      end

      def unabsorbed_insulin_total
        insulin_decode(d(17), d(18))
      end

      def bg_target_low
        d(12)
      end

      def bg_target_high
        d(21)
      end

      def insulin_sensitivity
        d(11)
      end

      def timestamp
        parse_date(2)
      end

      def carb_ratio
        ((d(9) & 0x7) << 8) + d(10) / 10.0
      end

      def as_json
        super.merge({
          bg: blood_glucose,
          bg_target_high: bg_target_high,
          correction_estimate: correction_estimate,
          carb_input: carbohydrates,
          unabsorbed_insulin_total: unabsorbed_insulin_total,
          bolus_estimate: bolus_estimate,
          carb_ratio: carb_ratio,
          food_estimate: food_estimate,
          bg_target_low: bg_target_low,
          sensitivity: insulin_sensitivity
        })
      end

    end
  end
end
