require 'spec_helper'

describe MinimedRF::HistoryPage do
  it "should decode 523 data" do
    data = "6ebf0f050000000000000002be02be640000000000000000000000000000000000000000000000000000000000000000000000007b0180de08010f11220006040c1e80c051410f0c0488c411010f7b018ac411010f11220006040c1eb1e651410f1a008fee11010f060303688fee71010f0c040e400001070c030f4000010764001f4000010717003740000107180080f616080f07000001efa18f0000006ea18f050000000000000001ef01ef64000000000000000000000000000000000000000000000000000000000000000000000000210084f616080f0b6b0080f736a80f030000002085f736080f7b0297f716080f2c1c007b0080c000090f001600070000001ea88f0036166ea88f0500000000000000001e001e6400000000000000000000000000000000006000000000000000000000000000c0000000b07b0180de08090f1122007b0280c016090f2c1c007b0080c0000a0f00160007000002bea98f0000006ea98f050000000000000002be02be640000000000000000000000000000000000000000000000000000000000000000000000007b0180de080a0f1122007b0280c0160a0f2c1c007b0080c0000b0f00160007000002beaa8f0000006eaa8f050000000000000002be02be640000000000000000000000000000000000000000000000000000000000000000000000007b0180de080b0f1122007b0280c0160b0f2c1c007b0080c0000c0f00160007000002beab8f0000006eab8f050000000000000002be02be640000000000000000000000000000000000000000000000000000000000000000000000007b0180de080c0f1122007b0280c0160c0f2c1c007b0080c0000d0f00160007000002beac8f0000006eac8f050000000000000002be02be640000000000000000000000000000000000000000000000000000000000000000000000007b0180de080d0f1122007b0280c0160d0f2c1c007b0080c0000e0f00160007000002bead8f0000006ead8f050000000000000002be02be640000000000000000000000000000000000000000000000000000000000000000000000007b0180de080e0f11220034649cf8140e0f0a6495fb340e0f5b64affb140e0f0f5000783c4100003200000000328c0100320032000000b0fb340e0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000095ba"
    history_page = MinimedRF::HistoryPage.new([data].pack('H*'))

    expect(history_page.crc_ok?).to eq true

    entries = history_page.decode
    expect(entries.length).to eq 51

    sara6e = entries[0]
    expect(sara6e.timestamp).to eq [2015, 10, 31, 0, 0, 0]

    calbg = entries[48]
    expect(calbg.to_s).to eq "CalBGForPH 2015/11/14 20:59:21 BG:100"

    bw = entries[49]
    expect(bw.blood_glucose).to eq 100
    expect(bw.bg_target_high).to eq 140
    expect(bw.unabsorbed_insulin_total).to eq 0
    expect(bw.correction_estimate).to eq 0
    expect(bw.bolus_estimate).to eq 1.25
    expect(bw.bg_target_low).to eq 65
    expect(bw.carb_ratio).to eq 12
    expect(bw.food_estimate).to eq 1.25
    expect(bw.carbohydrates).to eq 15
    expect(bw.insulin_sensitivity).to eq 60
  end

  it "should decode 530g data" do
    # capture7
    data = "41008ff9150f0f00560096f9550f0fdcdc002828560099f9350f0f282800dcdc6f129ef9150f0f6f21a3f9150f0f3364acf9150f0f081601acf9150f0f5000bbf9150f0f21011e003c14001e3c25c123b4460021011e003c14001e3c25c123b4450032009dc0160f0f61019dc0160f0f6a00a2c0160f0f6100a2c0160f0f3300b5d8160f0f081600b5d8160f0f7b02b5d8160f0f2c1c001e0195d9164f0f1f2089da164f0f7b0289da160f0f2c1c001e018de3164f0f1f2098e5164f0f7b0298e5160f0f2c1c000100080008000000a1d4570f0f50009fd5170f0f21011e003c14001e3c25c123b4450021011e003c14001e3c25c123b4440001000c000c000800aed5570f0f7b0080c000100f00160007000002ceaf8f0000006eaf8f050000000000000002ce02ba610014030000000000000000001400000002000000000000000000000000000000000000003202a5d300100f6101a5d300100f0100040004001000b6d340100f5732a1e800100f240ca7e820100f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009b39"
    history_page = MinimedRF::HistoryPage.new([data].pack('H*'))

    expect(history_page.crc_ok?).to eq true

    entries = history_page.decode
    expect(entries.length).to eq 51
  end
end
